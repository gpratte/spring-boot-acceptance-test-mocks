# spring-boot-acceptance-test-mocks
Spring Boot project that connects to various resources (database, mongo, rest calls, JMS messaging, Rabbit messaging, legacy). Mock the connections for acceptance testing.

As always I will build up the server in multiple steps. I will code each step on a new branch.

# Branches
## 01-spring-initalizr
Create a Spring Boot project using Spring Inializr https://start.spring.io/

Configure by taking the following steps...

1. Click the link to Switch to the full version. 

2. Change the following:
 * Generate a Gradle Project with Java and Spring Boot 1.5.19
 * Group com.example
 * Artifact message
 * Package Name com.example.message
 * Dependencies
    * Lombok
    * JMS (ActiveMQ)
    * Cloud Contract Stub Runner

Merge this branch to master.

## 02-receive-jms-message
To receive a JMS message I first wanted to have an ActiveMQ server running locally. To do this I

1. Installed ActiveMQ (http://activemq.apache.org/) by downloading the stand alone (the tar for mac)
2. Ran it via command line
3. Viewed it in the browser (http://localhost:8161/admin/)

I needed a starting place so I 
Googled Spring Boot JMS ActiveMQ and read
 * https://spring.io/guides/gs/messaging-jms/
 * https://dzone.com/articles/using-jms-in-spring-boot-1

I used the Spring Guide Spring Boot code (the first link above) as a starting point but removed the broker (that's for sending) and removed the sending code from Application

I also set the application.properties to my local ActiveMQ server and added the jackson dependency (that I learned from the second link above).

The Spring Boot code listens on the "mailbox" queue.
 
Brough up the Spring Boot server and it complains about not connecting to the queue.

Started the ActiveMQ server. In the ActiveMQ browser created a mailbox queue.

Brought up Spring Boot and no complaints.

In the ActiveMQ browser set the Type to TEXT and set the body to
```
{  
   "to" : "gpratte",
   "body" : "hi there"
}
```
and hit send.

Here is a screen shot 
![alt text](this-and-that/img/activemq-send-mailbox-queue.png?raw=true "ActiveMQ send message")

Spring boot complains 
`MessageConversionException: Could not find type id property [_type]`

## 03-message-converter

Tried to resolve the message conversion problem a few different ways to no avail.

Finally decided to roll my own converter. Changed the configuration to use the new EmailMessageConverter class.

Now the message posted to the mailbox queue is converted into an Email object.

__Note:__ If running server in IntelliJ remember to _Enable annotation processing_ to get Lombok to work.

## 04-cucumber

Added the cucumber dependencies and wrote a generic feature.

The tests can be run in IntelliJ or by the gradle command line.

There are 2 files for the step definitions which are `@Ignore` on purpose.

Here is the test report generated by the gradle command line
![alt text](this-and-that/img/gradle-test-results.png?raw=true "gradle test report")

## 05-embedded-message-server

Mock the message server for acceptance testing by using an embedded ActiveMQ server.

Used https://dzone.com/articles/using-jms-in-spring-boot-1 as a guide. 

Although everything I've read says to add the _activemq-broker_ test dependency I see that that dependency is already in the list of dependencies for my Spring Boot application. In IntelliJ expand the External Libraries in the project view and I see that it is already there. Hence I did not add it to the list of dependencies in the build.gradle.

Changed the cucumber test to send an email to the queue.

Did not start the ActiveMQ server on my system. Spring should use the embedded server.

Added an _application.properties_ file in the test resources folder and set the broker url as 
```
spring.activemq.broker-url=vm://localhost?broker.persistent=false
```

The biggest change came in the _EmailMessageConverter_. It now extends _MappingJackson2MessageConverter_ which converts the sent _Email_ -> JMS message. Also had to beef up the logic to convert a JMS message -> _Email_ because the message sent in the test is a _BytesMessage_ and not a _TextMessage_.

## 06-rest-call

After getting the message make a REST call.

To keep this simple called 

```
http://worldclockapi.com/api/json/utc/now
```



.